import ccxt
import pandas as pd
import ta
import time
import logging
import sys
import os
import requests
import csv
import threading

# Telegram Bilgileri
BOT_TOKEN = '5485088176:AAFyqxFDkTgi04zPTcxNaoLj89RtCFGPgY4'
CHAT_ID = '-1001687146213'

# Windows terminalde UTF-8 desteÄŸini aktif et
if os.name == "nt":
    sys.stdout.reconfigure(encoding='utf-8')
    sys.stderr.reconfigure(encoding='utf-8')

# Log dosyasÄ±na yazma ayarÄ±
logging.basicConfig(filename="trade_log.txt", level=logging.INFO,
                    format="%(asctime)s - %(message)s", encoding="utf-8")

print("Program baÅŸlatÄ±ldÄ±, hata tespit ediliyor...")

# Binance API BaÄŸlantÄ±sÄ± (Futures Modu)
try:
    binance = ccxt.binance({
        'apiKey': 'OzHexBKtuolWhjplCKDr32IPUOfiq9kPyBG1vo6kop7oNqbkjHCsu70HzeCLcLZ7',
        'secret': 'EGhxMrGdlqtaXw5ZJzHlA6gp1bXNEHkKQnJ1DI0gx8upjtlJT3FnuxtajDdGXCPh',
        'options': {'defaultType': 'future'},
        'rateLimit': 1200
    })
    print("Binance API BaÄŸlantÄ±sÄ± Kuruldu.")
except Exception as e:
    print(f"Binance API BaÄŸlantÄ± HatasÄ±: {e}")
    sys.exit()

TIMEFRAME = "5m"          # 5 dakika zaman dilimi

# KullanÄ±cÄ±dan iÅŸlem parametrelerini alma
try:
    USD_AMOUNT = float(input("Ä°ÅŸlem iÃ§in kullanÄ±lacak USD miktarÄ±nÄ± giriniz (Ã¶rn: 10): "))
    STOP_LOSS_PERCENT = float(input("Stop Loss yÃ¼zdesini giriniz (ondalÄ±k, Ã¶rn: 0.02 = %2): "))
    TAKE_PROFIT_PERCENT = float(input("Take Profit yÃ¼zdesini giriniz (ondalÄ±k, Ã¶rn: 0.015 = %1.5): "))
    LEVERAGE = float(input("KullanÄ±lacak kaldÄ±raÃ§ oranÄ±nÄ± giriniz (Ã¶rn: 20): "))
except Exception as e:
    print("Girdi hatasÄ±, lÃ¼tfen sayÄ±sal deÄŸerler giriniz.")
    sys.exit()

# KullanÄ±cÄ±dan iÅŸlem yapÄ±lacak kripto para Ã§iftlerini alma (virgÃ¼lle ayrÄ±lmÄ±ÅŸ)
try:
    pairs_input = input("Ä°ÅŸlem yapÄ±lacak kripto para Ã§iftlerini giriniz (Ã¶rn: BTCUSDT,ETHUSDT): ")
    PAIR_LIST = [pair.strip().upper() for pair in pairs_input.split(",")]
except Exception as e:
    print("Girdi hatasÄ±, lÃ¼tfen geÃ§erli kripto Ã§iftleri giriniz.")
    sys.exit()

# CSV'ye iÅŸlem loglarÄ±nÄ± yazmak iÃ§in fonksiyon
def log_trade(event_type, side, price, quantity, remarks=""):
    timestamp = pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S")
    row = {
        "timestamp": timestamp,
        "event_type": event_type,
        "side": side,
        "price": price,
        "quantity": quantity,
        "remarks": remarks
    }
    file_exists = os.path.isfile("trades.csv")
    with open("trades.csv", "a", newline="") as csvfile:
        fieldnames = ["timestamp", "event_type", "side", "price", "quantity", "remarks"]
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        if not file_exists or os.stat("trades.csv").st_size == 0:
            writer.writeheader()
        writer.writerow(row)
    debug_log(f"Ä°ÅŸlem kaydedildi: {row}")

# Telegram'a Mesaj GÃ¶nderme Fonksiyonu
def send_telegram_message(message):
    try:
        url = f"https://api.telegram.org/bot{BOT_TOKEN}/sendMessage"
        params = {'chat_id': CHAT_ID, 'text': message}
        response = requests.get(url, params=params, timeout=10)
        debug_log(f"Telegram yanÄ±t kodu: {response.status_code}")
        debug_log(f"Telegram yanÄ±t metni: {response.text}")
    except Exception as e:
        print(f"Telegram mesaj gÃ¶nderim hatasÄ±: {e}")
        logging.error(f"Telegram mesaj gÃ¶nderim hatasÄ±: {e}")

# Hata AyÄ±klama Ä°Ã§in AnlÄ±k Log YazdÄ±r
def debug_log(message):
    print(message)
    logging.info(message)

# Piyasa Verilerini Ã‡ekme
def fetch_market_data(pair, timeframe):
    try:
        debug_log(f"{pair} iÃ§in piyasa verisi Ã§ekiliyor...")
        bars = binance.fetch_ohlcv(pair, timeframe, limit=100)
        df = pd.DataFrame(bars, columns=['timestamp', 'open', 'high', 'low', 'close', 'volume'])
        return df
    except Exception as e:
        logging.error(f"fetch_market_data HatasÄ±: {e}")
        debug_log(f"fetch_market_data HatasÄ±: {e}")
        return None

# Teknik Analiz Sinyalleri Hesaplama
def calculate_indicators(df):
    try:
        df['rsi'] = ta.momentum.RSIIndicator(df['close'], window=7).rsi()
        bb = ta.volatility.BollingerBands(df['close'], window=10, window_dev=2)
        df['bb_upper'] = bb.bollinger_hband()
        df['bb_lower'] = bb.bollinger_lband()
        macd_indicator = ta.trend.MACD(df['close'], window_fast=12, window_slow=26, window_sign=9)
        df['macd'] = macd_indicator.macd()
        df['macd_signal'] = macd_indicator.macd_signal()
        df['rsi_ma'] = df['rsi'].rolling(window=3).mean()
        return df
    except Exception as e:
        logging.error(f"calculate_indicators HatasÄ±: {e}")
        debug_log(f"calculate_indicators HatasÄ±: {e}")
        return None

# AÃ§Ä±k PozisyonlarÄ± Getirme
def fetch_open_positions(pair):
    try:
        positions = binance.fetch_positions()
        debug_log(f"{pair} iÃ§in aÃ§Ä±k pozisyonlar: {positions}")
        return [p for p in positions if p.get('info', {}).get('symbol', '').strip() == pair]
    except Exception as e:
        logging.error(f"fetch_open_positions HatasÄ±: {e}")
        debug_log(f"fetch_open_positions HatasÄ±: {e}")
        return None

# AÃ§Ä±k Stop Loss / Take Profit Emirlerini Ä°ptal Etme Fonksiyonu
def cancel_sl_tp_orders(pair):
    try:
        orders = binance.fetch_open_orders(pair)
        for order in orders:
            order_type = order.get('type', '').upper()
            if order_type in ['STOP_MARKET', 'TAKE_PROFIT_MARKET']:
                binance.cancel_order(order['id'], pair)
                debug_log(f"Cancelled order {order['id']} (Type: {order_type}) for {pair}")
    except Exception as e:
        debug_log(f"cancel_sl_tp_orders error: {e}")

# Yeni iÅŸlem miktarÄ±nÄ± USD cinsinden aldÄ±ktan sonra BTC miktarÄ±na Ã§evirme (Leverage dahil)
def calculate_order_amount(last_close):
    try:
        # Ä°ÅŸlem miktarÄ± = (USD_AMOUNT * LEVERAGE) / last_close
        return (USD_AMOUNT * LEVERAGE) / last_close
    except Exception as e:
        debug_log(f"calculate_order_amount error: {e}")
        return None

# Stop-Loss ve Take-Profit Emirlerini Ayarla (Ã–nceki emirleri iptal ederek)
def set_stop_loss_take_profit(pair, order_type, entry_price, amount):
    """
    amount = BTC cinsinden miktar.
    entry_price = pozisyon aÃ§Ä±lÄ±ÅŸ fiyatÄ± (USDT cinsinden).
    """
    try:
        cancel_sl_tp_orders(pair)
        if order_type == "BUY":
            stop_loss_price = entry_price * (1 - STOP_LOSS_PERCENT)
            take_profit_price = entry_price * (1 + TAKE_PROFIT_PERCENT)
            side_for_sl_tp = "SELL"
        else:
            stop_loss_price = entry_price * (1 + STOP_LOSS_PERCENT)
            take_profit_price = entry_price * (1 - TAKE_PROFIT_PERCENT)
            side_for_sl_tp = "BUY"

        debug_log(f"{pair} iÃ§in SL: {stop_loss_price}, TP: {take_profit_price}")

        binance.create_order(
            symbol=pair,
            type="STOP_MARKET",
            side=side_for_sl_tp,
            amount=amount,
            params={"stopPrice": stop_loss_price, "positionSide": "BOTH"}
        )

        binance.create_order(
            symbol=pair,
            type="TAKE_PROFIT_MARKET",
            side=side_for_sl_tp,
            amount=amount,
            params={"stopPrice": take_profit_price, "positionSide": "BOTH"}
        )

        debug_log(f"{pair} iÃ§in SL & TP emirleri gÃ¶nderildi. SL: {stop_loss_price}, TP: {take_profit_price}")

        msg = (
            f"â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ’¹ YENÄ° POZÄ°SYON ğŸ’¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n"
            f"**Pozisyon TÃ¼rÃ¼**: {order_type}\n"
            f"**Kripto:** {pair}\n"
            f"**GiriÅŸ FiyatÄ±**: {entry_price}\n"
            f"**Stop Loss**: {stop_loss_price}\n"
            f"**Take Profit**: {take_profit_price}\n"
            f"**Miktar**: {amount} BTC\n"
            f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ğŸ“£â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        )
        send_telegram_message(msg)
        log_trade("ENTRY", order_type, entry_price, amount, "Yeni pozisyon aÃ§Ä±ldÄ±")
    except Exception as e:
        logging.error(f"set_stop_loss_take_profit HatasÄ±: {e}")
        debug_log(f"set_stop_loss_take_profit HatasÄ±: {e}")

# Ana Bot DÃ¶ngÃ¼sÃ¼: Her bir kripto para Ã§ifti iÃ§in Ã§alÄ±ÅŸacak ÅŸekilde dÃ¼zenlendi.
def trade_bot(pair):
    debug_log(f"{pair} iÃ§in Trade Bot BaÅŸlatÄ±ldÄ±!")
    send_telegram_message(
        f"â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ¤– BOT BAÅLATILDI ğŸ¤– â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n"
        f"{pair} iÃ§in Trade Bot aktif hale geldi ve piyasayÄ± izlemeye baÅŸladÄ±.\n"
        f"Her 5 dakikalÄ±k mum kapanÄ±ÅŸÄ±nda MACD ve RSI sinyallerine gÃ¶re iÅŸlem Ã¼retecek.\n\n"
        "Bol Åanslar!"
    )

    # Bot baÅŸlatÄ±ldÄ±ÄŸÄ±nda pozisyon bilgisini almak iÃ§in 10 saniye bekle
    time.sleep(10)
    positions = fetch_open_positions(pair)
    open_position_found = False
    if positions:
        for pos in positions:
            info_symbol = pos.get('info', {}).get('symbol', '').strip()
            position_amt = float(pos.get('info', {}).get('positionAmt', 0))
            debug_log(f"{pair} iÃ§in kontrol edilen sembol (info): {info_symbol} | positionAmt: {position_amt}")
            if info_symbol == pair and abs(position_amt) > 0:
                open_position_found = True
                position_side = "LONG" if position_amt > 0 else "SHORT"
                entry_price = pos.get('info', {}).get('entryPrice', 'Bilinmiyor')
                stop_loss = pos.get('info', {}).get('stopLossPrice')
                take_profit = pos.get('info', {}).get('takeProfitPrice')
                if not stop_loss:
                    stop_loss = "BelirtilmemiÅŸ"
                if not take_profit:
                    take_profit = "BelirtilmemiÅŸ"
                msg = (
                    f"â”€â”€â”€â”€â”€â”€â”€â”€â”€ ğŸ”” AÃ‡IK POZÄ°SYON BÄ°LGÄ°SÄ° ğŸ”” â”€â”€â”€â”€â”€â”€â”€â”€â”€\n\n"
                    f"**Kripto:** {pair}\n"
                    f"**Pozisyon TÃ¼rÃ¼**: {position_side}\n"
                    f"**GiriÅŸ FiyatÄ±**: {entry_price}\n"
                    f"**Miktar**: {position_amt} BTC\n"
                    f"**Stop Loss**: {stop_loss}\n"
                    f"**Take Profit**: {take_profit}\n"
                    f"â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                )
                send_telegram_message(msg)
                break

    if not open_position_found:
        send_telegram_message("â—ï¸ AÃ§Ä±k pozisyon bulunmamaktadÄ±r.")

    last_closed_candle_ts = None

    while True:
        try:
            df = fetch_market_data(pair, TIMEFRAME)
            if df is None:
                debug_log(f"{pair} iÃ§in piyasa verisi Ã§ekilemedi, tekrar denenecek.")
                time.sleep(60)
                continue

            df = calculate_indicators(df)
            if df is None:
                debug_log(f"{pair} iÃ§in indikatÃ¶r hesaplanamadÄ±, tekrar denenecek.")
                time.sleep(60)
                continue

            new_closed_candle_ts = df['timestamp'].iloc[-2]
            if new_closed_candle_ts != last_closed_candle_ts:
                debug_log(f"{pair} iÃ§in yeni bir 5 dakikalÄ±k mum kapandÄ±, sinyaller kontrol ediliyor...")
                last_closed_candle_ts = new_closed_candle_ts

                # Ä°ndikatÃ¶r deÄŸerlerini al
                prev_macd = df['macd'].iloc[-3]
                prev_macd_signal = df['macd_signal'].iloc[-3]
                current_macd = df['macd'].iloc[-2]
                current_macd_signal = df['macd_signal'].iloc[-2]
                prev_rsi = df['rsi'].iloc[-3]
                current_rsi = df['rsi'].iloc[-2]
                current_rsi_ma = df['rsi_ma'].iloc[-2]
                last_close = df['close'].iloc[-2]

                debug_log(f"{pair} iÃ§in Prev MACD: {prev_macd}, Prev MACD Signal: {prev_macd_signal}")
                debug_log(f"{pair} iÃ§in Current MACD: {current_macd}, Current MACD Signal: {current_macd_signal}")
                debug_log(f"{pair} iÃ§in Prev RSI: {prev_rsi}, Current RSI: {current_rsi}, RSI MA: {current_rsi_ma}")
                debug_log(f"{pair} iÃ§in Kapanan Mumun Close: {last_close}")

                positions = fetch_open_positions(pair)
                found_open_position = False

                # Mevcut pozisyon varsa reversal kontrolÃ¼ yap
                if positions:
                    for pos in positions:
                        info_symbol = pos.get('info', {}).get('symbol', '').strip()
                        position_amt = float(pos.get('info', {}).get('positionAmt', 0))
                        debug_log(f"{pair} iÃ§in kontrol edilen sembol (info): {info_symbol} | positionAmt: {position_amt}")
                        if info_symbol == pair and abs(position_amt) > 0:
                            found_open_position = True
                            current_side = "BUY" if position_amt > 0 else "SELL"
                            if current_side == "BUY" and (prev_macd > prev_macd_signal and current_macd < current_macd_signal and current_rsi < current_rsi_ma):
                                debug_log(f"{pair} iÃ§in aÃ§Ä±k LONG pozisyon tersine Ã§evriliyor (reversal sinyali).")
                                cancel_sl_tp_orders(pair)
                                binance.create_market_order(pair, "SELL", abs(position_amt))
                                debug_log(f"{pair} iÃ§in LONG pozisyon kapatÄ±ldÄ±.")
                                send_telegram_message("âœ”ï¸ LONG pozisyonu kapatÄ±ldÄ±, SHORT sinyali verildi.")
                                log_trade("EXIT", "SELL", last_close, abs(position_amt), "LONG pozisyon kapatÄ±ldÄ±")
                                order = binance.create_market_order(pair, "SELL", calculate_order_amount(last_close))
                                debug_log(f"{pair} iÃ§in SHORT iÅŸlemi aÃ§Ä±ldÄ±: {order}")
                                log_trade("ENTRY", "SELL", last_close, calculate_order_amount(last_close), "Yeni SHORT pozisyon aÃ§Ä±ldÄ±")
                                set_stop_loss_take_profit(pair, "SELL", last_close, calculate_order_amount(last_close))
                            elif current_side == "SELL" and (prev_macd < prev_macd_signal and current_macd > current_macd_signal and current_rsi > current_rsi_ma):
                                debug_log(f"{pair} iÃ§in aÃ§Ä±k SHORT pozisyon tersine Ã§evriliyor (reversal sinyali).")
                                cancel_sl_tp_orders(pair)
                                binance.create_market_order(pair, "BUY", abs(position_amt))
                                debug_log(f"{pair} iÃ§in SHORT pozisyon kapatÄ±ldÄ±.")
                                send_telegram_message("âœ”ï¸ SHORT pozisyonu kapatÄ±ldÄ±, LONG sinyali verildi.")
                                log_trade("EXIT", "BUY", last_close, abs(position_amt), "SHORT pozisyon kapatÄ±ldÄ±")
                                order = binance.create_market_order(pair, "BUY", calculate_order_amount(last_close))
                                debug_log(f"{pair} iÃ§in LONG iÅŸlemi aÃ§Ä±ldÄ±: {order}")
                                log_trade("ENTRY", "BUY", last_close, calculate_order_amount(last_close), "Yeni LONG pozisyon aÃ§Ä±ldÄ±")
                                set_stop_loss_take_profit(pair, "BUY", last_close, calculate_order_amount(last_close))
                if not found_open_position:
                    order_amount = calculate_order_amount(last_close)
                    if (prev_macd < prev_macd_signal and current_macd > current_macd_signal and current_rsi > current_rsi_ma):
                        debug_log(f"{pair} iÃ§in MACD sinyali yukarÄ± kesildi ve RSI > RSI MA, LONG aÃ§Ä±lÄ±yor.")
                        order = binance.create_market_order(pair, "BUY", order_amount)
                        debug_log(f"{pair} iÃ§in LONG iÅŸlemi aÃ§Ä±ldÄ±: {order}")
                        log_trade("ENTRY", "BUY", last_close, order_amount, "Yeni LONG pozisyon aÃ§Ä±ldÄ±")
                        set_stop_loss_take_profit(pair, "BUY", last_close, order_amount)
                    elif (prev_macd > prev_macd_signal and current_macd < current_macd_signal and current_rsi < current_rsi_ma):
                        debug_log(f"{pair} iÃ§in MACD sinyali aÅŸaÄŸÄ± kesildi ve RSI < RSI MA, SHORT aÃ§Ä±lÄ±yor.")
                        order = binance.create_market_order(pair, "SELL", order_amount)
                        debug_log(f"{pair} iÃ§in SHORT iÅŸlemi aÃ§Ä±ldÄ±: {order}")
                        log_trade("ENTRY", "SELL", last_close, order_amount, "Yeni SHORT pozisyon aÃ§Ä±ldÄ±")
                        set_stop_loss_take_profit(pair, "SELL", last_close, order_amount)

            debug_log("5 saniye bekleniyor...")
            time.sleep(5)

        except Exception as e:
            logging.error(f"{pair} iÃ§in trade_bot HatasÄ±: {e}")
            debug_log(f"{pair} iÃ§in trade_bot HatasÄ±: {e}")
            time.sleep(60)

# Main: Her bir kripto para Ã§ifti iÃ§in ayrÄ± thread baÅŸlatÄ±lÄ±yor
def main():
    threads = []
    for pair in PAIR_LIST:
        t = threading.Thread(target=trade_bot, args=(pair,))
        t.start()
        threads.append(t)
    for t in threads:
        t.join()

try:
    main()
except Exception as e:
    debug_log(f"Beklenmeyen Hata: {e}")
    input("Devam etmek iÃ§in ENTER tuÅŸuna basÄ±n...")
